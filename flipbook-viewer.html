<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pembaca Buku Digital - Perpustakaan Sunda</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
      rel="stylesheet"
    />

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>

    <!-- Turn.js for flipbook effect -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #2093a4;
        --secondary: #4fb3d1;
        --bg: #0a0f1c;
        --text-color: #e2e8f0;
      }

      body {
        font-family: "DM Sans", sans-serif;
        background: var(--bg);
        color: var(--text-color);
        overflow: hidden;
      }

      /* Header */
      .reader-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(10, 15, 28, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        z-index: 1000;
      }

      .reader-title {
        color: var(--text-color);
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .reader-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .audio-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-right: auto;
      }

      .audio-controls .control-btn {
        background: rgba(32, 147, 164, 0.8);
      }

      .audio-controls .control-btn:hover {
        background: var(--primary);
      }

      .audio-controls .control-btn.playing {
        background: var(--secondary);
      }

      .audio-controls .control-btn.auto-play-on {
        background: var(--primary);
        color: white;
      }

      .audio-controls .control-btn.auto-play-off {
        background: rgba(128, 128, 128, 0.3);
        color: #888;
      }

      .control-btn {
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.3rem;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: var(--primary);
      }

      .page-info {
        color: var(--text-color);
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.3rem;
      }

      /* Main Container */
      .reader-container {
        position: absolute;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0a0f1c 0%, #1a1f2e 100%);
        padding: 2rem;
      }

      /* Flipbook Container */
      .flipbook-container {
        position: relative;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #flipbook {
        width: 1200px;
        height: 800px;
        margin: 0 auto;
        max-width: 95vw;
        max-height: 85vh;
      }

      .page {
        background: white;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .page canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .page-number {
        position: absolute;
        bottom: 10px;
        right: 15px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 0.3rem;
        font-size: 0.8rem;
      }

      /* Navigation */
      .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background: rgba(32, 147, 164, 0.8);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 100;
      }

      .nav-btn:hover {
        background: var(--primary);
        transform: translateY(-50%) scale(1.1);
      }

      .nav-btn.prev {
        left: -80px;
      }

      .nav-btn.next {
        right: -80px;
      }

      /* Loading */
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(10, 15, 28, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .loading-content {
        text-align: center;
        color: var(--text-color);
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .progress-bar {
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin: 1rem auto 0;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.3s ease;
      }

      /* Error State */
      .error-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-color);
      }

      .error-state i {
        font-size: 4rem;
        color: #ef4444;
        margin-bottom: 1rem;
      }

      .error-state h3 {
        margin-bottom: 1rem;
        color: #ef4444;
      }

      .error-state p {
        opacity: 0.8;
        margin-bottom: 2rem;
      }

      .btn-back {
        padding: 0.8rem 2rem;
        background: var(--primary);
        border: none;
        border-radius: 0.5rem;
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-back:hover {
        background: var(--secondary);
        transform: translateY(-1px);
      }

      /* Zoom Controls */
      .zoom-controls {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 1000;
      }

      .zoom-btn {
        width: 40px;
        height: 40px;
        background: rgba(32, 147, 164, 0.8);
        border: none;
        border-radius: 0.3rem;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .zoom-btn:hover {
        background: var(--primary);
      }

      /* Fullscreen */
      .fullscreen-btn {
        position: fixed;
        bottom: 2rem;
        left: 2rem;
        width: 40px;
        height: 40px;
        background: rgba(32, 147, 164, 0.8);
        border: none;
        border-radius: 0.3rem;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .fullscreen-btn:hover {
        background: var(--primary);
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .reader-header {
          padding: 0 1rem;
        }

        .reader-title {
          font-size: 1rem;
        }

        .reader-container {
          padding: 1rem;
        }

        .flipbook-container {
          padding: 1rem;
        }

        #flipbook {
          width: 100%;
          max-width: 600px;
          height: 450px;
        }

        .nav-btn {
          width: 40px;
          height: 40px;
        }

        .nav-btn.prev {
          left: -60px;
        }

        .nav-btn.next {
          right: -60px;
        }

        .zoom-controls,
        .fullscreen-btn {
          bottom: 1rem;
        }
      }

      /* Tablet styles */
      @media (max-width: 1024px) and (min-width: 769px) {
        #flipbook {
          width: 90vw;
          height: 70vh;
          max-width: 900px;
          max-height: 600px;
        }

        .flipbook-container {
          padding: 1rem;
        }

        .nav-btn {
          width: 50px;
          height: 50px;
        }
      }

      @media (max-width: 768px) {
        .flipbook-container {
          padding: 0.5rem;
        }

        #flipbook {
          width: 95vw;
          height: 60vh;
          max-width: 600px;
          max-height: 450px;
        }

        .nav-btn {
          width: 45px;
          height: 45px;
        }

        .nav-btn.prev {
          left: -55px;
        }

        .nav-btn.next {
          right: -55px;
        }

        .zoom-controls,
        .fullscreen-btn {
          bottom: 1rem;
        }

        .reader-header {
          padding: 0.5rem 1rem;
        }

        .reader-controls {
          gap: 0.5rem;
        }

        .audio-controls {
          gap: 0.3rem;
        }

        .audio-controls .control-btn {
          width: 35px;
          height: 35px;
          padding: 0.3rem;
        }

        .reader-title span {
          font-size: 1rem;
        }
      }

      @media (max-width: 480px) {
        #flipbook {
          width: 98vw;
          height: 55vh;
          max-height: 350px;
        }

        .nav-btn.prev {
          left: 5px;
        }

        .nav-btn.next {
          right: 5px;
        }

        .zoom-controls button {
          width: 35px;
          height: 35px;
          font-size: 0.9rem;
        }

        .reader-header {
          padding: 0.5rem;
        }

        .reader-title span {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="reader-header">
      <div class="reader-title">
        <img
          src="img/logo-sikabayan.png"
          alt="Logo Sikabayan"
          style="height: 50px; margin-right: 10px"
        />
        <i data-feather="book-open"></i>
        <span id="bookTitle" style="color: #2093a4"
          >Sikabayan - Memuat Buku...</span
        >
      </div>

      <div class="reader-controls">
        <div class="audio-controls">
          <button
            class="control-btn"
            id="playPauseBtn"
            onclick="toggleAudio()"
            title="Putar/Berhenti Audio"
          >
            <i data-feather="play" id="playIcon"></i>
          </button>
          <button
            class="control-btn"
            id="stopBtn"
            onclick="stopAudio()"
            title="Hentikan Audio"
          >
            <i data-feather="square"></i>
          </button>
          <button
            class="control-btn"
            id="autoPlayBtn"
            onclick="toggleAutoPlay()"
            title="Auto-play: ON"
          >
            <i data-feather="repeat" id="autoPlayIcon"></i>
          </button>
          <button
            class="control-btn"
            id="debugBtn"
            onclick="debugCurrentPage()"
            title="Debug Text (Console)"
            style="display: none"
          >
            <i data-feather="info"></i>
          </button>
        </div>
        <div class="page-info" id="pageInfo">Halaman 1 dari 1</div>
        <button
          class="control-btn"
          onclick="toggleFullscreen()"
          title="Layar Penuh"
        >
          <i data-feather="maximize"></i>
        </button>
        <button class="control-btn" onclick="window.close()" title="Tutup">
          <i data-feather="x"></i>
        </button>
      </div>
    </div>

    <!-- Main Container -->
    <div class="reader-container">
      <div class="flipbook-container">
        <div id="flipbook">
          <!-- Pages will be loaded here -->
        </div>

        <!-- Navigation Buttons -->
        <button
          class="nav-btn prev"
          onclick="previousPage()"
          title="Halaman Sebelumnya"
        >
          <i data-feather="chevron-left"></i>
        </button>
        <button
          class="nav-btn next"
          onclick="nextPage()"
          title="Halaman Selanjutnya"
        >
          <i data-feather="chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Zoom Controls -->
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()" title="Perbesar">
        <i data-feather="zoom-in"></i>
      </button>
      <button class="zoom-btn" onclick="zoomOut()" title="Perkecil">
        <i data-feather="zoom-out"></i>
      </button>
      <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
        <i data-feather="minimize-2"></i>
      </button>
    </div>

    <!-- Fullscreen Button -->
    <button
      class="fullscreen-btn"
      onclick="toggleFullscreen()"
      title="Layar Penuh"
    >
      <i data-feather="maximize"></i>
    </button>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Memuat buku digital...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="loadingStatus">Menginisialisasi...</p>
      </div>
    </div>

    <!-- Error State -->
    <div class="error-state" id="errorState" style="display: none">
      <i data-feather="alert-circle"></i>
      <h3>Gagal Memuat Buku</h3>
      <p>
        Maaf, terjadi kesalahan saat memuat buku digital. Silakan coba lagi atau
        kembali ke perpustakaan.
      </p>
      <button class="btn-back" onclick="window.close()">
        Kembali ke Perpustakaan
      </button>
    </div>

    <script>
      // PDF.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js";

      // Configure PDF.js for better text extraction
      pdfjsLib.GlobalWorkerOptions.isEvalSupported = false;
      pdfjsLib.GlobalWorkerOptions.enableLegacyBuild = true;

      let pdfDoc = null;
      let currentZoom = 1.8; // Increased from 1.2 for better clarity
      let totalPages = 0;
      let currentPage = 1;
      let renderedPages = new Set(); // Cache for rendered pages

      // Text-to-Speech variables
      let speechSynthesis = window.speechSynthesis;
      let currentUtterance = null;
      let isPlaying = false;
      let pageTexts = new Map(); // Cache for extracted page texts
      let autoPlayEnabled = true; // Auto-play audio on page change

      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const filename = urlParams.get("file");
      const bookTitle = urlParams.get("title") || "Buku Digital";

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        if (!filename) {
          showError("File tidak ditemukan");
          return;
        }

        // Initialize auto-play setting from localStorage
        const savedAutoPlay = localStorage.getItem("flipbookAutoPlay");
        if (savedAutoPlay !== null) {
          autoPlayEnabled = savedAutoPlay === "true";
        }

        document.getElementById("bookTitle").textContent = bookTitle;
        loadPDF();
        feather.replace();

        // Update auto-play UI after a short delay
        setTimeout(() => {
          updateAutoPlayUI();
        }, 100);
      });

      async function loadPDF() {
        try {
          updateLoadingStatus("Mengunduh file PDF...");
          updateProgress(10);

          const url = `materials/story-book/${filename}`;

          updateLoadingStatus("Memproses dokumen...");
          updateProgress(30);

          // Configure PDF loading options for better text extraction
          const loadingTask = pdfjsLib.getDocument({
            url: url,
            cMapUrl:
              "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/cmaps/",
            cMapPacked: true,
            enableXfa: true,
            useSystemFonts: true,
          });

          pdfDoc = await loadingTask.promise;
          totalPages = pdfDoc.numPages;

          console.log("PDF loaded successfully:", {
            numPages: totalPages,
            fingerprint: pdfDoc.fingerprints,
            title: await pdfDoc
              .getMetadata()
              .then((m) => m.info.Title)
              .catch(() => "Unknown"),
          });

          updateLoadingStatus("Memuat halaman pertama...");
          updateProgress(60);

          // Only render first 2-4 pages initially for faster loading
          await renderInitialPages();

          updateLoadingStatus("Menginisialisasi flipbook...");
          updateProgress(90);

          initializeFlipbook();

          updateLoadingStatus("Selesai!");
          updateProgress(100);

          setTimeout(() => {
            hideLoading();
            updatePageInfo();

            // Auto-play audio for the first page after loading
            setTimeout(() => {
              autoPlayPageAudio(1);
            }, 500);
          }, 300);
        } catch (error) {
          console.error("Error loading PDF:", error);
          showError("Gagal memuat file PDF");
        }
      }

      async function renderInitialPages() {
        const flipbook = document.getElementById("flipbook");
        flipbook.innerHTML = "";

        // Create placeholder divs for all pages
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
          const pageDiv = document.createElement("div");
          pageDiv.className = "page-container";
          pageDiv.setAttribute("data-page", pageNum);
          pageDiv.style.width = "100%";
          pageDiv.style.height = "100%";
          pageDiv.style.backgroundColor = "#f5f5f5";
          pageDiv.style.display = "flex";
          pageDiv.style.alignItems = "center";
          pageDiv.style.justifyContent = "center";
          pageDiv.style.fontSize = "1rem";
          pageDiv.innerHTML = `<div style="color: #666; text-align: center;">Loading page ${pageNum}...</div>`;
          flipbook.appendChild(pageDiv);
        }

        // Render only first 4 pages initially
        const initialPages = Math.min(4, totalPages);
        for (let pageNum = 1; pageNum <= initialPages; pageNum++) {
          await renderPage(pageNum);
        }
      }

      async function renderPage(pageNum) {
        // Skip if already rendered
        if (renderedPages.has(pageNum)) {
          return;
        }

        try {
          const page = await pdfDoc.getPage(pageNum);
          const viewport = page.getViewport({ scale: currentZoom });

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          canvas.style.maxWidth = "100%";
          canvas.style.height = "auto";

          await page.render({
            canvasContext: context,
            viewport: viewport,
          }).promise;

          // Replace placeholder with actual page
          const pageContainer = document.querySelector(
            `[data-page="${pageNum}"]`
          );
          if (pageContainer) {
            pageContainer.innerHTML = "";
            pageContainer.appendChild(canvas);
            renderedPages.add(pageNum); // Mark as rendered
          }
        } catch (error) {
          console.error(`Error rendering page ${pageNum}:`, error);
        }
      }

      async function renderAdditionalPages(startPage, endPage) {
        for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
          // Skip if already rendered
          if (!renderedPages.has(pageNum)) {
            await renderPage(pageNum);
          }
        }
      }

      function initializeFlipbook() {
        const isDesktop = window.innerWidth > 768;
        const flipbookWidth = isDesktop
          ? 1200
          : Math.min(window.innerWidth * 0.95, 600);
        const flipbookHeight = isDesktop
          ? 800
          : Math.min(window.innerHeight * 0.7, 450);

        $("#flipbook").turn({
          width: flipbookWidth,
          height: flipbookHeight,
          autoCenter: true,
          duration: 1000,
          elevation: 50,
          gradients: true,
          when: {
            turned: function (event, page, view) {
              currentPage = page;
              updatePageInfo();

              // Stop current audio when page changes
              stopAudio();

              // Auto-play audio for the new page after a short delay
              setTimeout(() => {
                autoPlayPageAudio(page);
              }, 500);

              // Lazy load nearby pages
              const preloadRange = 2;
              const startPage = Math.max(1, page - preloadRange);
              const endPage = Math.min(totalPages, page + preloadRange);

              // Load pages in background without blocking UI
              setTimeout(() => {
                renderAdditionalPages(startPage, endPage);
              }, 100);
            },
          },
        });

        // Keyboard navigation
        $(document).keydown(function (e) {
          switch (e.which) {
            case 37: // left arrow
              previousPage();
              break;
            case 39: // right arrow
              nextPage();
              break;
            case 27: // escape
              if (document.fullscreenElement) {
                document.exitFullscreen();
              }
              break;
            case 68: // D key for debug
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                debugCurrentPage();
              }
              break;
            case 32: // spacebar for play/pause
              e.preventDefault();
              toggleAudio();
              break;
          }
        });
      }

      function previousPage() {
        $("#flipbook").turn("previous");
      }

      function nextPage() {
        $("#flipbook").turn("next");
      }

      function updatePageInfo() {
        const pageInfo = document.getElementById("pageInfo");
        pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
      }

      function updateLoadingStatus(status) {
        document.getElementById("loadingStatus").textContent = status;
      }

      function updateProgress(percent) {
        document.getElementById("progressFill").style.width = percent + "%";
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }

      function showError(message) {
        document.getElementById("loadingOverlay").style.display = "none";
        const errorState = document.getElementById("errorState");
        errorState.style.display = "block";
        errorState.querySelector("p").textContent = message;
        feather.replace();
      }

      // Text-to-Speech Functions
      async function extractTextFromPage(pageNum) {
        if (pageTexts.has(pageNum)) {
          return pageTexts.get(pageNum);
        }

        console.log(`Starting text extraction for page ${pageNum}`);

        try {
          const page = await pdfDoc.getPage(pageNum);

          // Try primary text extraction method
          try {
            const textContent = await page.getTextContent();
            console.log(`Page ${pageNum} text content:`, textContent);

            if (textContent.items && textContent.items.length > 0) {
              const text = textContent.items.map((item) => item.str).join(" ");
              console.log(`Page ${pageNum} extracted text:`, text);

              // Clean and format text for better narration
              const cleanText = text
                .replace(/\s+/g, " ")
                .replace(/([.!?])\s*([A-Z])/g, "$1 $2")
                .trim();

              if (cleanText && cleanText.length >= 3) {
                pageTexts.set(pageNum, cleanText);
                console.log(
                  `Successfully extracted text for page ${pageNum}: "${cleanText.substring(
                    0,
                    50
                  )}..."`
                );
                return cleanText;
              }
            }
          } catch (textError) {
            console.warn(
              `Text extraction failed for page ${pageNum}:`,
              textError
            );
          }

          // If primary extraction fails, try alternative method
          console.log(`Trying alternative text extraction for page ${pageNum}`);
          const alternativeText = await tryAlternativeTextExtraction(
            page,
            pageNum
          );
          if (alternativeText && alternativeText.length >= 3) {
            pageTexts.set(pageNum, alternativeText);
            return alternativeText;
          }

          // If all extraction methods fail, use fallback
          console.log(
            `All text extraction failed for page ${pageNum}, using fallback`
          );
          const fallbackText = getFallbackTextForPage(pageNum);
          pageTexts.set(pageNum, fallbackText);
          return fallbackText;
        } catch (error) {
          console.error("Error extracting text from page:", pageNum, error);
          const fallbackText = getFallbackTextForPage(pageNum);
          pageTexts.set(pageNum, fallbackText);
          return fallbackText;
        }
      }

      async function tryAlternativeTextExtraction(page, pageNum) {
        try {
          // Try getting text with different options
          const textContent = await page.getTextContent({
            normalizeWhitespace: true,
            disableCombineTextItems: false,
          });

          if (textContent.items && textContent.items.length > 0) {
            // Try different extraction methods
            const methods = [
              // Method 1: Simple join
              () => textContent.items.map((item) => item.str).join(" "),

              // Method 2: Preserve formatting
              () =>
                textContent.items
                  .map((item) => item.str)
                  .filter((str) => str.trim().length > 0)
                  .join(" "),

              // Method 3: Join with newlines for multi-line text
              () => {
                let text = "";
                let lastY = null;
                textContent.items.forEach((item) => {
                  if (
                    lastY !== null &&
                    Math.abs(item.transform[5] - lastY) > 5
                  ) {
                    text += " ";
                  }
                  text += item.str;
                  lastY = item.transform[5];
                });
                return text;
              },
            ];

            for (let i = 0; i < methods.length; i++) {
              try {
                const text = methods[i]();
                const cleanText = text.replace(/\s+/g, " ").trim();
                if (cleanText && cleanText.length >= 3) {
                  console.log(
                    `Alternative method ${
                      i + 1
                    } successful for page ${pageNum}: "${cleanText.substring(
                      0,
                      50
                    )}..."`
                  );
                  return cleanText;
                }
              } catch (methodError) {
                console.warn(
                  `Alternative method ${i + 1} failed for page ${pageNum}:`,
                  methodError
                );
              }
            }
          }

          return null;
        } catch (error) {
          console.warn(
            `Alternative text extraction failed for page ${pageNum}:`,
            error
          );
          return null;
        }
      }

      function getFallbackTextForPage(pageNum) {
        // Get book-specific content based on filename or title
        const bookSpecificText = getBookSpecificText(filename, pageNum);
        if (bookSpecificText) {
          return bookSpecificText;
        }

        // Provide general fallback content based on common children's book patterns
        const fallbackTexts = [
          "Ini adalah halaman dengan gambar yang menarik. Mari kita lihat apa yang terjadi di halaman ini.",
          "Halaman ini menunjukkan cerita yang indah dengan gambar yang penuh warna.",
          "Di halaman ini, kita dapat melihat kelanjutan dari cerita yang menarik.",
          "Gambar di halaman ini menceritakan bagian penting dari dongeng kita.",
          "Mari kita nikmati ilustrasi yang indah di halaman ini sambil berimajinasi.",
          "Halaman ini penuh dengan detail menarik yang dapat kita amati bersama.",
          "Cerita berlanjut dengan gambar yang menunjukkan petualangan selanjutnya.",
          "Di sini kita melihat momen penting dalam perjalanan karakter utama kita.",
        ];

        // Use different fallback text for different pages
        const textIndex = (pageNum - 1) % fallbackTexts.length;
        return fallbackTexts[textIndex];
      }

      function getBookSpecificText(filename, pageNum) {
        // Define specific content for known books
        const bookContents = {
          "kupu-kupu-bordir.pdf": {
            1: "Era sekali, hiduplah seorang gadis kecil yang senang sekali menyulam dan membuat bordiran yang indah.",
            2: "Suatu hari, ia menemukan sepasang kupu-kupu yang terbang di kebunnya dengan sayap yang berkilauan seperti benang emas.",
            3: "Gadis kecil itu terpesona dengan keindahan kupu-kupu tersebut dan ingin membuat bordiran yang sama indahnya.",
            4: "Ia mulai menyulam dengan penuh semangat, meniru pola sayap kupu-kupu yang ia lihat di kebun.",
            5: "Dengan sabar dan tekun, ia membuat bordiran kupu-kupu yang sangat indah dan menawan.",
            6: "Ketika bordiran selesai, kupu-kupu asli datang dan hinggap di atas karya seninya, seolah memberikan persetujuan.",
            7: "Dari hari itu, gadis kecil menjadi terkenal dengan bordiran kupu-kupu yang sangat indah dan penuh makna.",
          },
          "akar-nu-kuat.pdf": {
            1: "Di sebuah hutan yang lebat, tumbuh sebuah pohon besar dengan akar yang sangat kuat dan dalam.",
            2: "Pohon itu sudah berusia ratusan tahun dan menjadi tempat berlindung berbagai makhluk hutan.",
            3: "Suatu hari, datang badai besar yang menghancurkan banyak pohon di hutan tersebut.",
            4: "Namun pohon besar itu tetap berdiri tegak karena akarnya yang kuat mencengkeram bumi dengan erat.",
            5: "Hewan-hewan hutan berlindung di bawah pohon besar itu hingga badai berlalu.",
            6: "Setelah badai, semua makhluk hutan bersyukur kepada pohon besar yang telah melindungi mereka.",
            7: "Pohon itu mengajarkan bahwa kekuatan sejati datang dari akar yang kuat dan dalam.",
          },
          "curug-dengdeng.pdf": {
            1: "Di lereng gunung yang hijau, terdapat air terjun yang indah bernama Curug Dengdeng.",
            2: "Air terjun ini memiliki suara gemuruh yang terdengar seperti musik alam yang merdu.",
            3: "Konon, air terjun ini adalah tempat tinggal bidadari yang turun dari kahyangan.",
            4: "Setiap pagi, kabut tipis menyelimuti air terjun, menciptakan pemandangan yang sangat memukau.",
            5: "Banyak orang datang untuk menikmati keindahan dan kesegaran air Curug Dengdeng.",
            6: "Air terjun ini juga dipercaya memiliki kekuatan untuk menyembuhkan dan memberikan keberuntungan.",
            7: "Curug Dengdeng tetap menjadi keajaiban alam yang harus dijaga dan dilestarikan.",
          },
        };

        const bookContent = bookContents[filename.toLowerCase()];
        if (bookContent && bookContent[pageNum]) {
          return bookContent[pageNum];
        }

        return null;
      }

      async function speakCurrentPage() {
        if (!pdfDoc || currentPage < 1 || currentPage > totalPages) {
          console.log("Invalid page or PDF not loaded");
          return;
        }

        try {
          console.log(`Speaking page ${currentPage}`);
          const text = await extractTextFromPage(currentPage);

          console.log(`Text for page ${currentPage}:`, text);

          if (!text || text.trim().length === 0) {
            const fallbackText = getFallbackTextForPage(currentPage);
            console.log(
              `Using fallback text for page ${currentPage}:`,
              fallbackText
            );
            speakText(`Halaman ${currentPage}. ${fallbackText}`);
            return;
          }

          // Add page number introduction
          const pageIntro = `Halaman ${currentPage}. `;
          const fullText = pageIntro + text;

          console.log(`Speaking full text:`, fullText);
          speakText(fullText);
        } catch (error) {
          console.error("Error speaking current page:", error);
          const errorText = `Halaman ${currentPage}. Terjadi kesalahan saat membaca halaman ini.`;
          speakText(errorText);
        }
      }

      function debugCurrentPage() {
        console.log("=== DEBUG CURRENT PAGE ===");
        console.log("Current Page:", currentPage);
        console.log("Total Pages:", totalPages);
        console.log("PDF Doc:", pdfDoc);
        console.log("Filename:", filename);
        console.log("Book Title:", bookTitle);

        if (pdfDoc && currentPage >= 1 && currentPage <= totalPages) {
          // Force refresh - clear cache first
          pageTexts.delete(currentPage);

          extractTextFromPage(currentPage)
            .then((text) => {
              console.log("=== EXTRACTION RESULT ===");
              console.log("Extracted Text:", text);
              console.log("Text Length:", text ? text.length : 0);
              console.log(
                "Is Fallback:",
                !text ||
                  text.includes("gambar yang menarik") ||
                  text.includes("Era sekali")
              );
              console.log("Cached Texts:", pageTexts);

              // Test speech immediately
              if (text) {
                console.log("Testing speech synthesis...");
                const testUtterance = new SpeechSynthesisUtterance(
                  "Test audio: " + text.substring(0, 100)
                );
                testUtterance.rate = 0.8;
                testUtterance.lang = "id-ID";
                speechSynthesis.speak(testUtterance);
              }
            })
            .catch((error) => {
              console.error("Debug extraction failed:", error);
            });
        }

        // Show debug button temporarily
        const debugBtn = document.getElementById("debugBtn");
        debugBtn.style.display = "flex";
        setTimeout(() => {
          debugBtn.style.display = "none";
        }, 10000); // 10 seconds for more time to see
      }

      function speakText(text) {
        // Stop any current speech
        if (currentUtterance) {
          speechSynthesis.cancel();
        }

        currentUtterance = new SpeechSynthesisUtterance(text);

        // Configure voice settings for Indonesian
        currentUtterance.lang = "id-ID";
        currentUtterance.rate = 0.8; // Slightly slower for better comprehension
        currentUtterance.pitch = 1.1; // Slightly higher pitch for children's stories
        currentUtterance.volume = 1.0;

        // Event handlers
        currentUtterance.onstart = function () {
          isPlaying = true;
          updateAudioUI();
        };

        currentUtterance.onend = function () {
          isPlaying = false;
          currentUtterance = null;
          updateAudioUI();
        };

        currentUtterance.onerror = function (event) {
          console.error("Speech synthesis error:", event);
          isPlaying = false;
          currentUtterance = null;
          updateAudioUI();
        };

        speechSynthesis.speak(currentUtterance);
      }

      function toggleAudio() {
        if (isPlaying) {
          pauseAudio();
        } else {
          speakCurrentPage();
        }
      }

      function pauseAudio() {
        if (speechSynthesis.speaking) {
          speechSynthesis.pause();
          isPlaying = false;
          updateAudioUI();
        }
      }

      function resumeAudio() {
        if (speechSynthesis.paused) {
          speechSynthesis.resume();
          isPlaying = true;
          updateAudioUI();
        }
      }

      function stopAudio() {
        speechSynthesis.cancel();
        isPlaying = false;
        currentUtterance = null;
        updateAudioUI();
      }

      function updateAudioUI() {
        const playBtn = document.getElementById("playPauseBtn");
        const playIcon = document.getElementById("playIcon");

        if (isPlaying) {
          playBtn.classList.add("playing");
          playIcon.setAttribute("data-feather", "pause");
          playBtn.title = "Jeda Audio";
        } else {
          playBtn.classList.remove("playing");
          playIcon.setAttribute("data-feather", "play");
          playBtn.title = "Putar Audio";
        }

        feather.replace();
      }

      async function autoPlayPageAudio(pageNum) {
        // Only auto-play if enabled
        if (!autoPlayEnabled) return;

        // Wait for page to be rendered if not already
        await ensurePageIsRendered(pageNum);

        // Auto-play audio for the new page
        if (pdfDoc && pageNum >= 1 && pageNum <= totalPages) {
          try {
            const text = await extractTextFromPage(pageNum);

            if (!text || text.trim().length === 0) {
              const fallbackText = `Halaman ${pageNum}. Halaman ini tidak memiliki teks yang dapat dibaca.`;
              speakText(fallbackText);
              return;
            }

            // Add page number introduction
            const pageIntro = `Halaman ${pageNum}. `;
            const fullText = pageIntro + text;

            speakText(fullText);
          } catch (error) {
            console.error("Error auto-playing page audio:", error);
            const errorText = `Halaman ${pageNum}. Terjadi kesalahan saat membaca halaman ini.`;
            speakText(errorText);
          }
        }
      }

      async function ensurePageIsRendered(pageNum) {
        const maxWaitTime = 3000; // Maximum 3 seconds
        const checkInterval = 100; // Check every 100ms
        let waitTime = 0;

        return new Promise((resolve) => {
          const checkRendered = () => {
            const pageContainer = document.querySelector(
              `[data-page="${pageNum}"]`
            );
            const hasCanvas =
              pageContainer && pageContainer.querySelector("canvas");

            if (hasCanvas || waitTime >= maxWaitTime) {
              resolve();
            } else {
              waitTime += checkInterval;
              setTimeout(checkRendered, checkInterval);
            }
          };

          checkRendered();
        });
      }

      function toggleAutoPlay() {
        autoPlayEnabled = !autoPlayEnabled;
        updateAutoPlayUI();

        // Save preference to localStorage
        localStorage.setItem("flipbookAutoPlay", autoPlayEnabled.toString());
      }

      function updateAutoPlayUI() {
        const autoPlayBtn = document.getElementById("autoPlayBtn");
        const autoPlayIcon = document.getElementById("autoPlayIcon");

        if (autoPlayEnabled) {
          autoPlayBtn.classList.add("auto-play-on");
          autoPlayBtn.classList.remove("auto-play-off");
          autoPlayBtn.title = "Auto-play: ON (Klik untuk matikan)";
          autoPlayIcon.setAttribute("data-feather", "repeat");
        } else {
          autoPlayBtn.classList.add("auto-play-off");
          autoPlayBtn.classList.remove("auto-play-on");
          autoPlayBtn.title = "Auto-play: OFF (Klik untuk nyalakan)";
          autoPlayIcon.setAttribute("data-feather", "repeat");
        }

        feather.replace();
      }

      function zoomIn() {
        currentZoom = Math.min(currentZoom * 1.2, 3);
        reloadPDF();
      }

      function zoomOut() {
        currentZoom = Math.max(currentZoom / 1.2, 0.5);
        reloadPDF();
      }

      function resetZoom() {
        currentZoom = 1.5;
        reloadPDF();
      }

      async function reloadPDF() {
        if (!pdfDoc) return;

        document.getElementById("loadingOverlay").style.display = "flex";
        updateLoadingStatus("Mengatur ulang zoom...");

        const currentPageNum = currentPage;

        await renderAllPages();

        $("#flipbook").turn("destroy");
        initializeFlipbook();

        $("#flipbook").turn("page", currentPageNum);

        hideLoading();
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch((err) => {
            console.log("Error attempting to enable fullscreen:", err);
          });
        } else {
          document.exitFullscreen();
        }
      }

      // Handle fullscreen changes
      document.addEventListener("fullscreenchange", function () {
        const fullscreenBtns = document.querySelectorAll(
          ".control-btn i, .fullscreen-btn i"
        );
        fullscreenBtns.forEach((btn) => {
          if (
            btn.getAttribute("data-feather") === "maximize" ||
            btn.getAttribute("data-feather") === "minimize"
          ) {
            btn.setAttribute(
              "data-feather",
              document.fullscreenElement ? "minimize" : "maximize"
            );
          }
        });
        feather.replace();
      });

      // Prevent context menu on right click
      document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
      });

      // Handle window resize
      window.addEventListener("resize", function () {
        if ($("#flipbook").turn("is")) {
          $("#flipbook").turn("resize");
        }
      });

      // Clean up on window unload
      // Window resize handler
      window.addEventListener("resize", function () {
        if ($("#flipbook").turn("is")) {
          const isDesktop = window.innerWidth > 768;
          const flipbookWidth = isDesktop
            ? 1200
            : Math.min(window.innerWidth * 0.95, 600);
          const flipbookHeight = isDesktop
            ? 800
            : Math.min(window.innerHeight * 0.7, 450);

          $("#flipbook").turn("size", flipbookWidth, flipbookHeight);
        }
      });

      window.addEventListener("beforeunload", function () {
        if ($("#flipbook").turn("is")) {
          $("#flipbook").turn("destroy");
        }
      });
    </script>
  </body>
</html>
